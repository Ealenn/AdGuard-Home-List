name: Publish

on:
  push:
    branches:
      - "master"
  schedule:
    - cron: '0 4 * * *'

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v5
      with:
        lfs: true

    - uses: actions/setup-node@v4
      with:
        node-version: 22

    - name: Install & Build
      run: |
        mkdir public
        cd ./modules/cli
        npm ci
        npm run build
      env:
        CI: true

    - name: Generate AllowList
      run: |
        node ./modules/cli/dist/main.js generate \
        --name AdGuard-Home-List.Allow.txt \
        --badge badge-allow.json \
        --external ./allowlist/external \
        --custom ./allowlist/custom \
        --concatExternal ./allowlist/concat \
        --convertToAllow true \
        --output ./public

    - name: Generate BlockList
      run: |
        node ./modules/cli/dist/main.js generate \
        --name AdGuard-Home-List.Block.txt \
        --badge badge-block.json \
        --external ./blocklist/external \
        --custom ./blocklist/custom \
        --concatExternal ./blocklist/concat \
        --output ./public

    - name: Split Public/Debug
      run: |
        split -b 50m -d -a 3 "public/debug.AdGuard-Home-List.Allow.txt" "public/Debug-AdGuard-Home-List.Allow.txt.part-"
        split -b 50m -d -a 3 "public/debug.AdGuard-Home-List.Block.txt" "public/Debug-AdGuard-Home-List.Block.txt.part-"
        rm public/debug.AdGuard-Home-List.Allow.txt
        rm public/debug.AdGuard-Home-List.Block.txt
      env:
        CI: true

    - name: Deploy
      uses: JamesIves/github-pages-deploy-action@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        folder: public
        clean: true
        single-commit: true
        force: true
